name: Deploy Headless Site
on:
  workflow_dispatch:
    inputs:
      environment:
        type: environment

jobs:
  deploy:
    name: Deploy to CDN
    runs-on: windows-latest
    environment: ${{inputs.environment}}
    defaults:
      run:
        working-directory: site

    steps:
      # Checkout the code
      - name: Checkout branch
        uses: actions/checkout@v3

      # Sets up our deployment 
      - uses: "./.github/workflows/composite/setup"
        with:
          deployment_type: "cdnassets"

      # Runs webpack to copy the source to the build folder
      - name: Build
        run: npm run build${{ inputs.environment == 'Prod' && '-prod-ci' || ''}}

      # Runs akumina-widget-builder with the cdnpackage option to prep widgets for deployment
      - name: CDN Package
        run: npm run cdnpackage

      # Runs site deployer
      # We have chosen to use the tools/deploy.js script which reads from akumina.sitedeployer.config.json
      - name: Deploy to CDN
        run: npm run deploy
        env:
          assetdirectory: Client
          azurestorageaccountkey: ${{ secrets.azure_storage_account_key }}
          azurestorageaccountname: ${{ vars.azure_storage_account_name }}
          azurestoragecontainer: ${{ vars.azure_storage_account_container }}
          spdirectory: DigitalWorkplace
          envdir: build

      # Stores an artifact copy on the workflow run
      - name: Upload built artifact
        uses: actions/upload-artifact@v4
        with:
          path: site/build